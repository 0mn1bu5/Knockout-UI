/*! Knockout-UI - A home for rich UI components based on KnockoutJS Copyright (c) 2013 Ian Mckay */
(function(){var e=function(e,i){"undefined"!=typeof debug&&$("<div></div>").appendTo(i||"#log").text((new Date).toGMTString()+" : ui-tree.js - "+e)},i=new ko.jqueryTmplTemplateEngine,t=function(e,i,t){var n=t.defaults[e];return void 0===t.defaults[i]||void 0===t.defaults[i][e]?ko.utils.unwrapObservable(n):ko.utils.unwrapObservable(t.defaults[i][e])},n=function(e,i,s){this.viewModel=s,this.parent=ko.observable(i),this.id=ko.observable(e.id),this.name=ko.observable(e.name),this.contextMenu=s.contextMenu,this.cssClass=ko.observable(e.cssClass||"folder"),this.isRenaming=ko.observable(!1),this.type=ko.observable(e.type||this.cssClass()),this.contents=e.contents,this.level=ko.dependentObservable(function(){try{return this.parent().name(),this.parent().level(),this.parent().level()+1}catch(e){return 0}},this);var d,o,a=this,l=this.viewModel;if(this.children=ko.observableArray([]),void 0!==e.children)for(o=0;e.children.length>o;o+=1)void 0!==e.children[o]&&this.children.push(new n(e.children[o],a,l));this.unqiueIdentifier=function(){return this.viewModel.id()+this.type()+this.id()},this.isOpen=ko.observable(!1);var r=$.cookie(this.unqiueIdentifier()+"open");null!==r?this.isOpen("true"===r):void 0!==e.isOpen&&this.isOpen(e.isOpen),this.saveState=function(){void 0===$.cookie&&this.viewModel.remember()?alert("You must include $.cookie in order to use this feature"):this.viewModel.remember()&&($.cookie(this.unqiueIdentifier()+"open",this.isOpen()),this.isSelected()&&$.cookie(this.viewModel.id()+"active",this.unqiueIdentifier()))},this.selectNode=function(){var e=this.viewModel.selectedNode(),i=this;void 0!==e&&e.isRenaming()&&$(".rename > .node input",s.tree).blur(),this.saveState(),(void 0===e||void 0!==e&&e!==this)&&i.viewModel.handlers.selectNode(this,function(){void 0!==e&&(e.isSelected(!1),e.isRenaming(!1)),i.isSelected(!0),i.viewModel.selectedNode(i),i.saveState()})}.bind(this),this.isSelected=ko.observable(!1);var h=$.cookie(this.viewModel.id()+"active");(null!==h&&h===this.unqiueIdentifier()||e.isSelected)&&this.selectNode(),this.canAddChildren=ko.dependentObservable(function(){var e=t("canAddChildren",this.type(),this.viewModel);return e},this),this.isDropTarget=ko.dependentObservable(function(){var e=t("isDropTarget",this.type(),this.viewModel);return e},this),this.connectToSortable=ko.dependentObservable(function(){var e=t("connectToSortable",this.type(),this.viewModel);return e},this),this.isDraggable=ko.dependentObservable(function(){var e=(this.name(),!1),i=t("isDraggable",this.type(),this.viewModel);return $.each(this.children(),function(i,t){return e=t.isRenaming(),e?!1:void 0}),!this.isRenaming()&&!e&&i},this),this.hasChildren=function(){return this.children().length>0}.bind(this),this.hasContext=function(){return void 0!==this.contextMenu}.bind(this),this.isdragHolder=function(){s.dragHolder(this)}.bind(this),this.dropped=function(){return s.dragHolder()}.bind(this),d=function(e){var i=e;do i.isOpen(!0),i=i.parent();while(void 0!==i.parent)},this.addChild=function(e){if(this.canAddChildren()){var i=t("childType",this.type(),this.viewModel),o=void 0!==e.type?e.type:i,l=t("name",o,this.viewModel),r=void 0!==e.name?e.name:l,h=void 0!==e.rename?e.rename:t("renameAfterAdd",o,this.viewModel),c=this;s.handlers.addNode(this,o,r,function(e){if(void 0!==e){var i=new n(e,a,c.viewModel);c.children.push(i),d(c),c.isSelected(!1),i.selectNode(),h&&i.isRenaming(!0),s.recalculateSizes(),c.saveState()}})}}.bind(this),this.setViewModel=function(e){var i;for(i=0;this.children().length>i;i+=1)this.children()[i].setViewModel(e);this.viewModel=e,this.contextMenu=e.contextMenu}.bind(this),this.deleteSelf=function(e){var i=this;s.handlers.deleteNode(this,e,function(){$.each(i.children(),function(i,t){t.deleteSelf(e)}),void 0!==i.parent()&&i.parent().children.remove(i),s.recalculateSizes()})}.bind(this),this.rename=function(e){var i=this;s.handlers.renameNode(this,this.name(),e,function(){i.name(e),s.recalculateSizes()})}.bind(this),this.move=function(e){var i=this;s.handlers.moveNode(e,this,function(){e.parent().children.remove(e),e.parent(i),i.children.push(e),i.isOpen(!0),e.selectNode(),s.recalculateSizes(),i.saveState()})}.bind(this),this.doubleClick=function(){s.handlers.doubleClick(this)}.bind(this),this.clicked=function(e){switch(e.which){case 1:this.selectNode();break;case 3:s.handlers.rightClick(this)}}.bind(this),this.toggleFolder=function(){this.isOpen(!this.isOpen()),s.recalculateSizes(),this.saveState()}.bind(this),this.indent=function(){return 11*this.level()+"px"}.bind(this)};ko.tree={viewModel:function(i){this.selectedNode=ko.observable(void 0),this.defaults={isDraggable:!0,isDropTarget:!0,canAddChildren:!0,childType:"folder",renameAfterAdd:!0,connectToSortable:!1,dragCursorAt:{left:28,bottom:0},dragCursor:"auto",dragHelper:function(){return $("<div></div>").addClass("drag-icon").append($("<span></span>").addClass(this.cssClass()))}},this.handlers={selectNode:function(t,n){e("select node "+t.name(),i.logTo),n()},addNode:function(t,n,s,d){e("add new node ",i.logTo),d({id:10,parent:t,name:s})},renameNode:function(t,n,s,d){e('rename node "'+n+'" to "'+s+'"',i.logTo),d()},deleteNode:function(t,n,s){e('delete node "'+t.name()+'"',i.logTo),s()},moveNode:function(t,n,s){e('move node "'+t.name()+'" to "'+n.name()+'"',i.logTo),s()},doubleClick:function(t){e("doubled clicked "+t.name(),i.logTo)},rightClick:function(t){e("right click "+t.name(),i.logTo)},startDrag:function(){e("start drag",i.logTo)},endDrag:function(){e("stop drag",i.logTo)}},$.extend(this.handlers,i.handlers||{}),i.defaults&&$.extend(!0,this.defaults,i.defaults),this.id=ko.observable(i.id),this.remember=ko.observable(i.remember||!1),this.logTo=i.logTo;var s=this;i.contextMenu&&(this.contextMenu=new ko.contextMenu.viewModel(i.contextMenu)),this.children=ko.observableArray([]);var d;for(d=0;i.children.length>d;d+=1){var o=i.children[d];this.children.push(new n(o,s,s))}this.tree=void 0,this.dragHolder=i.dragHolder||ko.observable(void 0),this.recalculateSizes=function(){var e,i=0;$(".node:visible",this.tree).each(function(t,n){var s=0,d=$(n);s+=d.children("label").outerWidth(!0),s+=d.children(".icon").outerWidth(!0),s+=d.children(".handle").outerWidth(!0),s>i&&(i=s,e=d)}),$(".node",this.tree).css("minWidth",i+5)}.bind(this),this.addNode=function(e){if(e instanceof n)e.isSelected(!1),e.setViewModel(s),e.parent(s),s.children.push(e),e.selectNode();else if(void 0!==e&&void 0===e.parent||0===this.children().length){var i=void 0!==e.type?e.type:t("childType",void 0,this),d=void 0!==e.name?e.name:t("name",i,this),o=void 0!==e.rename?e.rename:t("renameAfterAdd",i,this);this.handlers.addNode(void 0,i,d,function(e){if(void 0!==e){var i=new n(e,s,s);s.children.push(i),i.selectNode(),o&&i.isRenaming(!0),s.recalculateSizes(),i.saveState()}})}else this.selectedNode().addChild(e||{})}.bind(this),this.deleteNode=function(e){void 0!==this.selectedNode()&&this.selectedNode().deleteSelf(e)}.bind(this),this.renameNode=function(){void 0!==this.selectedNode()&&this.selectedNode().isRenaming(!0)}.bind(this)}},ko.addTemplateSafe("nodeTemplate",'					{{if hasContext() }}						<li class="${cssClass}" data-bind="contextMenu : contextMenu, css: { empty: !hasChildren(), open: isOpen, rename: isRenaming }" data-id="${ id() }">					{{else}}						<li class="${cssClass}" data-bind="css: { empty: !hasChildren(), open: isOpen, rename: isRenaming }" data-id="${ id() }">					{{/if}}						<div class="node" data-bind="nodeDrag : isDraggable(), nodeDrop: { active : isDropTarget(), onDropComplete: move }, css :{ selected: isSelected }, hover : \'hover\', event : { dblclick : doubleClick, mousedown: clicked }">							{{if hasChildren() }}								<span class="handle" data-bind="click: toggleFolder, bubble : false, style: { marginLeft: indent() }, hover : \'hover\'"></span>{{else}}<span class="handle" data-bind="style: { marginLeft: indent() }"></span>{{/if}}<span class="icon"></span><label data-bind="visible: !isRenaming()" unselectable="on">${ name }</label><input class="rename" type="text" data-bind="nodeRename: name, onRenameComplete : rename, nodeSelectVisible: isRenaming"/>						</div>						{{if hasChildren() }}							<ul data-bind=\'visible: isOpen, template: { name: "nodeTemplate", foreach: children }\'></ul>						{{/if}}					</li>',i),ko.addTemplateSafe("containerTemplate",'<ul class="tree" data-bind=\'template: { name : "nodeTemplate", foreach: children }\'></ul>',i),ko.bindingHandlers.nodeDrag={init:function(e,i,n,s){var d=$(e),o=s,a={revert:"invalid",revertDuration:250,cancel:"span.handle",cursor:t("dragCursor",o.type(),o.viewModel),cursorAt:t("dragCursorAt",o.type(),o.viewModel),appendTo:"body",connectToSortable:s.connectToSortable(),helper:function(e,i){var n=t("dragHelper",o.type(),o.viewModel);return n.call(s,e,i)},zIndex:2e5,addClasses:!1,distance:10,start:function(){s.isdragHolder(),s.viewModel.handlers.startDrag(s)},stop:function(){s.viewModel.handlers.endDrag(s)}};d.draggable(a)},update:function(e,i){var t=$(e),n=ko.utils.unwrapObservable(i());n?t.draggable("enable"):t.draggable("disable")}},ko.bindingHandlers.nodeDrop={init:function(e,i,t,n){var s=$(e),d=i()||{},o=ko.utils.unwrapObservable(d.onDropComplete),a={greedy:!0,tolerance:"pointer",addClasses:!1,drop:function(){setTimeout(function(){o(n.dropped())},0)}};s.droppable(a)},update:function(e,i){var t=$(e),n=ko.utils.unwrapObservable(i()).active;n?t.droppable("enable"):t.droppable("disable")}},ko.bindingHandlers.nodeSelectVisible={update:function(e,i){ko.bindingHandlers.visible.update(e,i);var t="none"===e.style.display;t||e.select()}},ko.bindingHandlers.nodeRename={updateValue:function(e,i,t,n){var s=t().onRenameComplete,d=ko.selectExtensions.readValue(e);s(d),n.isRenaming(!1)},init:function(e,i,t,n){var s=$(e),d=function(){ko.bindingHandlers.nodeRename.updateValue(e,i,t,n)};s.click(function(){return!1}).focus("focus",function(){}),s.bind("blur",d),s.bind("keyup",function(e){13===e.which&&d()})},update:function(e,i){ko.bindingHandlers.value.update(e,i)}},ko.bindingHandlers.tree={init:function(t,n){var s,d=n();d.tree=t,s=t.appendChild(document.createElement("DIV")),e("Initialize tree "+d.children().length+" root nodes found",d.logTo),ko.renderTemplate("containerTemplate",d,{templateEngine:i},s,"replaceNode"),d.recalculateSizes()}}})();