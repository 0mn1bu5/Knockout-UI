/*!
 * Knockout-UI v0.5.0
 * A home for rich UI components based on KnockoutJS
 * Copyright (c) 2013 Ian Mckay
 * https://github.com/madcapnmckay/Knockout-UI.git
 * License: MIT (http://opensource.org/licenses/mit-license.php)
**/
(function(t){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?t(require("knockout"),require("jquery"),require("ui-core"),exports):"function"==typeof define&&define.amd?define(["knockout","jquery","ui-core","exports"],t):(ko.ui=ko.ui===void 0?{core:{}}:ko.ui,t(ko,$,ko.ui.core,ko.ui))})(function(t,e,n,i){"use strict";var o,a="ko_dragItem";t.addTemplate("tmpl_ui_tree_node",["<li>","<div data-bind='UITreeNode: $data'>","<span data-bind='UITreeNodeHandle: {}'></span>","<span data-bind='UITreeNodeIcon: {}'></span>","<label data-bind='UITreeNodeLabel: {}'></label>","<input type='text' data-bind='UITreeNodeTextBox: {}' />","</div>","<ul data-bind='template: { name: 'tmpl_ui_tree_node', foreach: nodes }, visible: open'></ul>","</li>"].join("")),t.addTemplate("tmpl_ui_tree","<ul data-bind='template: { name: 'tmpl_ui_tree_node', foreach: nodes }, attr: { class: options.css.tree }'></ul>"),i.defaults=i.defaults||{},o=i.defaults.tree={templates:{tree:"tmpl_ui_tree",node:"tmpl_ui_tree_node"},css:{tree:"ui-tree",icon:"ui-icon",handle:"ui-handle",emptyHandle:"ui-no-child",node:"ui-node",selected:"ui-selected",open:"open"},node:{indent:16,title:"New Folder",childType:"folder",draggable:!0,droppable:!0},events:{click:"click",context:"context",dblClick:"dblClick",added:"added",toggle:"toggle",edit:"edit",renamed:"renamed",removed:"removed",moved:"moved"},draggable:{addClasses:!1,appendTo:"body",revertDuration:250,connectToSortable:!1,dragCursorAt:{left:28,bottom:0},dragCursor:"auto",distance:10,zIndex:2e5,helper:function(t,n,i){return e("<div></div>").addClass("drag-icon").append(e("<span></span>").addClass(i))}},droppable:{addClasses:!1,greedy:!0,tolerance:"pointer",hoverClass:"ui-drop-target"}},i.ANode=n.Component.extend({init:function(e){var i,o,a=this,s=[],r=e.nodes?e.nodes.length:0;for(this._super(e),o=0;r>o;o+=1)i=new this.nodeType(n.extend(e.nodes[o],{options:this.options,parent:this})),s.push(i);this.nodes=t.observableArray(s),this.children=t.observable(!(!this.nodes().length&&!e.children)),this.nodes.subscribe(function(){a.children(!!a.nodes().length)}),this.parent=e.parent},get:function(t,e,n){if(this.id===t)return this;if(e)return null;var i,o=null,a=this.nodes.length;for(i=0;a>i;i+=1)if(o=this.nodes[i].get(t,n))return o;return o},notifySelfAndRoot:function(t){var e=n.createEvent(t),i=this.notify(t.name,e);return e.isPropogationStopped()||i||!this.root||(i=this.root.notify(t.name,e)),e.isDefaultPrevented()?{then:n.NOOP}:n.when(i)},add:function(e,i){var o=this;e=n.isArray(e)?e:[e],this.notifySelfAndRoot({name:o.options.events.added,nodes:t.utils.arrayMap(e,function(t){return n.extend({title:o.options.node.title},t,{parentId:o.id||-1,parentType:o.type})})}).then(function(e){var a=n.isArray(e)?e:[e],s=t.utils.arrayMap(a,function(t){return new o.nodeType(n.extend(t,{options:o.options,parent:o}))});o.nodes.push.apply(o.nodes,s),o.toggle(!0),i&&(s[0].select(!0),s[0].edit())}.bind(this))},toggle:n.NOOP,toString:function(){return this.title()+" ("+this.id+")"}}),i.TreeNode=i.ANode.extend({init:function(e){n.extend(!0,{exlude:["nodes"]},this,e),this.root=e.parent.root||e.parent,this.options=e.options||this.root.options,this.title=t.observable(e.title||this.options.node.title),this.open=t.observable(e.open||!1),this.editing=t.observable(e.editing||!1),this.selected=t.observable(!1),this.draggable=e.draggable||this.options.node.draggable,this.droppable=e.droppable||this.options.node.droppable,this.loading=t.observable(!1),this.type=e.type||this.options.node.childType||"folder",this.nodeType=i.TreeNode,this.level=t.observable(n.unwrap(e.parent.level)+1),this._super(e)},toggle:function(t){this.notifySelfAndRoot({name:this.options.events.toggle,node:this,force:t}).then(function(e){this.open.toggle(t),e&&this.open()&&this.children()&&!this.nodes().length&&this.add(e)}.bind(this))},select:function(e){this.notifySelfAndRoot({name:this.options.events.click,node:this}).then(function(){this.selected.toggle(),this.selected()?(e&&(t.utils.arrayForEach(this.root.selected,function(t){t.selected(!1)}),this.root.selected=[]),this.root.selected.push(this)):t.utils.arrayRemoveItem(this.root.selected,this)}.bind(this))},context:function(){this.notifySelfAndRoot({name:this.options.events.context,node:this})},dblClick:function(){this.notifySelfAndRoot({name:this.options.events.dblClick,node:this})},move:function(t){this.parent===t||t.isDescendentOf(this)||this.notifySelfAndRoot({name:this.options.events.moved,node:this,to:t}).then(function(){this.parent.nodes.remove(this),t.nodes.push(this),this.parent=t,this.level(n.unwrap(this.parent.level)+1)}.bind(this))},edit:function(){this.notifySelfAndRoot({name:this.options.events.edit,node:this}).then(function(){this.previousValue=this.title(),this.editing(!0),this.root.editing=this}.bind(this))},rename:function(){this.editing()&&this.notifySelfAndRoot({name:this.options.events.renamed,node:this,from:this.previousValue,to:this.title()}).then(function(){this.editing(!1),this.root.editing=null}.bind(this))},isDescendentOf:function(t){if(t===this)return!0;var e=this.parent;do{if(e===t)return!0;e=e.parent}while(e);return!1}}),i.Tree=i.ANode.extend({init:function(t){var a=this;this.options=n.extend({},o,t.options),this.level=-1,this.nodeType=i.TreeNode,this.selected=[],this._super(t),e("body").click(function(){a.editing&&a.editing.rename()})},add:function(t){this.selected.length?this.selected[this.selected.length-1].add(t,!0):this._super(t,!0)},edit:function(){this.selected.length&&this.selected[this.selected.length-1].edit()},remove:function(){for(var t,e,n=this.selected.slice(0),i=[];n.length;){var o=n.pop(),a=!1;for(t=0,e=n.length;e>t;t+=1)if(o.isDescendentOf(n[t])){a=!0;break}a||i.push(o)}this.notifySelfAndRoot({name:this.options.events.removed,nodes:i}).then(function(){for(t=0,e=i.length;e>t;t+=1)i[t].parent.nodes.remove(i[t])})}}),t.bindingHandlers.tree={init:function(e,o){var a=n.unwrap(o());if(!(a instanceof i.Tree))throw Error("The tree binding requires an instance of ko.ui.Tree viewModel");return t.renderTemplate(a.options.templates.tree,a,{},e.appendChild(document.createElement("div")),"replaceNode"),{controlsDescendantBindings:!0}}},t.bindingHandlers.UITreeNode={init:function(i,o,s,r){var d,u,l,p,c,h=e(i);t.proxyBinding.call(this,"init",i,s,r,{event:function(){return{click:function(t,e){c?c=!1:r.select(!e.metaKey)},dblclick:r.dblClick,contextmenu:function(){return r.context(),c=!0,!1}}}}),t.utils.domData.set(i,a,r),n.unwrap(r.draggable)&&(u=r.options.draggable.drop,l=n.extend({},r.options.draggable,{start:function(){u&&u.apply(this,arguments)}}),h.draggable(l)),n.unwrap(r.droppable)&&(d=r.options.droppable.drag,p=n.extend({},r.options.droppable,{drop:function(e,n){d&&d.apply(this,arguments),setTimeout(function(){t.utils.domData.get(n.draggable.get(0),a).move(r)},0)}}),h.droppable(p)),t.utils.domNodeDisposal.addDisposeCallback(i,function(){h.draggable&&h.draggable("destroy"),h.droppable&&h.droppable("destroy")})},update:function(e,n,i,o){t.proxyBinding.call(this,"update",e,i,o,{attr:function(){return{"class":o.options.css.node}},css:function(){var t={};return t[o.options.css.selected]=o.selected,t[o.options.css.open]=o.open,t[o.type]=!0,t}})}},t.bindingHandlers.UITreeNodeHandle={init:function(n,i,o,a){var s=e(n),r=function(t){s.css("marginLeft",t*a.options.node.indent)};a.level.subscribe(r),r(a.level()),t.bindingHandlers.click.init.call(this,n,function(){return function(){a.toggle()}},o,a)},update:function(e,n,i,o){t.bindingHandlers.attr.update.call(this,e,function(){return{"class":t.computed({read:function(){var t=o.options.css.handle;return t+=o.children()?"":" "+o.options.css.emptyHandle},disposeWhenNodeIsRemoved:e})}},i,o)}},t.bindingHandlers.UITreeNodeIcon={init:function(e,n,i,o){t.bindingHandlers.attr.update.call(this,e,function(){return{"class":o.options.css.icon}},i,o)}},t.bindingHandlers.UITreeNodeLabel={update:function(e,n,i,o){t.proxyBinding.call(this,"update",e,i,o,{text:function(){return o.title},visible:function(){return t.computed(function(){return!o.editing()})}})}},t.bindingHandlers.UITreeNodeTextBox={init:function(e,n,i,o){t.proxyBinding.call(this,"init",e,i,o,{event:function(){return{click:function(t,e){e.stopPropagation()},blur:o.rename}},value:function(){return o.title}}),o.editing.subscribe(function(t){t&&setTimeout(function(){e.focus(),e.select()},0)})},update:function(e,n,i,o){t.proxyBinding.call(this,"update",e,i,o,{visible:function(){return o.editing},value:function(){return o.title}})}}});