/*!
 * Knockout-UI v0.5.0
 * A home for rich UI components based on KnockoutJS
 * Copyright (c) 2013 Ian Mckay
 * https://github.com/madcapnmckay/Knockout-UI.git
 * License: MIT (http://opensource.org/licenses/mit-license.php)
**/
(function(){var e=function(e,t){"undefined"!=typeof debug&&$("<div></div>").appendTo(t||"#log").text((new Date).toGMTString()+" : ui-tree.js - "+e)},t=new ko.jqueryTmplTemplateEngine,i=function(e,t,i){var n=i.defaults[e];return void 0===i.defaults[t]||void 0===i.defaults[t][e]?ko.utils.unwrapObservable(n):ko.utils.unwrapObservable(i.defaults[t][e])},n=function(e,t,s){this.viewModel=s,this.parent=ko.observable(t),this.id=ko.observable(e.id),this.name=ko.observable(e.name),this.contextMenu=s.contextMenu,this.cssClass=ko.observable(e.cssClass||"folder"),this.isRenaming=ko.observable(!1),this.type=ko.observable(e.type||this.cssClass()),this.contents=e.contents,this.level=ko.dependentObservable(function(){try{return this.parent().name(),this.parent().level(),this.parent().level()+1}catch(e){return 0}},this);var a,o,d=this,l=this.viewModel;if(this.children=ko.observableArray([]),void 0!==e.children)for(o=0;e.children.length>o;o+=1)void 0!==e.children[o]&&this.children.push(new n(e.children[o],d,l));this.unqiueIdentifier=function(){return this.viewModel.id()+this.type()+this.id()},this.isOpen=ko.observable(!1);var r=$.cookie(this.unqiueIdentifier()+"open");null!==r?this.isOpen("true"===r):void 0!==e.isOpen&&this.isOpen(e.isOpen),this.saveState=function(){void 0===$.cookie&&this.viewModel.remember()?alert("You must include $.cookie in order to use this feature"):this.viewModel.remember()&&($.cookie(this.unqiueIdentifier()+"open",this.isOpen()),this.isSelected()&&$.cookie(this.viewModel.id()+"active",this.unqiueIdentifier()))},this.selectNode=function(){var e=this.viewModel.selectedNode(),t=this;void 0!==e&&e.isRenaming()&&$(".rename > .node input",s.tree).blur(),this.saveState(),(void 0===e||void 0!==e&&e!==this)&&t.viewModel.handlers.selectNode(this,function(){void 0!==e&&(e.isSelected(!1),e.isRenaming(!1)),t.isSelected(!0),t.viewModel.selectedNode(t),t.saveState()})}.bind(this),this.isSelected=ko.observable(!1);var c=$.cookie(this.viewModel.id()+"active");(null!==c&&c===this.unqiueIdentifier()||e.isSelected)&&this.selectNode(),this.canAddChildren=ko.dependentObservable(function(){var e=i("canAddChildren",this.type(),this.viewModel);return e},this),this.isDropTarget=ko.dependentObservable(function(){var e=i("isDropTarget",this.type(),this.viewModel);return e},this),this.connectToSortable=ko.dependentObservable(function(){var e=i("connectToSortable",this.type(),this.viewModel);return e},this),this.isDraggable=ko.dependentObservable(function(){var e=(this.name(),!1),t=i("isDraggable",this.type(),this.viewModel);return $.each(this.children(),function(t,i){return e=i.isRenaming(),e?!1:void 0}),!this.isRenaming()&&!e&&t},this),this.hasChildren=function(){return this.children().length>0}.bind(this),this.hasContext=function(){return void 0!==this.contextMenu}.bind(this),this.isdragHolder=function(){s.dragHolder(this)}.bind(this),this.dropped=function(){return s.dragHolder()}.bind(this),a=function(e){var t=e;do t.isOpen(!0),t=t.parent();while(void 0!==t.parent)},this.addChild=function(e){if(this.canAddChildren()){var t=i("childType",this.type(),this.viewModel),o=void 0!==e.type?e.type:t,l=i("name",o,this.viewModel),r=void 0!==e.name?e.name:l,c=void 0!==e.rename?e.rename:i("renameAfterAdd",o,this.viewModel),h=this;s.handlers.addNode(this,o,r,function(e){if(void 0!==e){var t=new n(e,d,h.viewModel);h.children.push(t),a(h),h.isSelected(!1),t.selectNode(),c&&t.isRenaming(!0),s.recalculateSizes(),h.saveState()}})}}.bind(this),this.setViewModel=function(e){var t;for(t=0;this.children().length>t;t+=1)this.children()[t].setViewModel(e);this.viewModel=e,this.contextMenu=e.contextMenu}.bind(this),this.deleteSelf=function(e){var t=this;s.handlers.deleteNode(this,e,function(){$.each(t.children(),function(t,i){i.deleteSelf(e)}),void 0!==t.parent()&&t.parent().children.remove(t),s.recalculateSizes()})}.bind(this),this.rename=function(e){var t=this;s.handlers.renameNode(this,this.name(),e,function(){t.name(e),s.recalculateSizes()})}.bind(this),this.move=function(e){var t=this;s.handlers.moveNode(e,this,function(){e.parent().children.remove(e),e.parent(t),t.children.push(e),t.isOpen(!0),e.selectNode(),s.recalculateSizes(),t.saveState()})}.bind(this),this.doubleClick=function(){s.handlers.doubleClick(this)}.bind(this),this.clicked=function(e){switch(e.which){case 1:this.selectNode();break;case 3:s.handlers.rightClick(this)}}.bind(this),this.toggleFolder=function(){this.isOpen(!this.isOpen()),s.recalculateSizes(),this.saveState()}.bind(this),this.indent=function(){return 11*this.level()+"px"}.bind(this)};ko.tree={viewModel:function(t){this.selectedNode=ko.observable(void 0),this.defaults={isDraggable:!0,isDropTarget:!0,canAddChildren:!0,childType:"folder",renameAfterAdd:!0,connectToSortable:!1,dragCursorAt:{left:28,bottom:0},dragCursor:"auto",dragHelper:function(){return $("<div></div>").addClass("drag-icon").append($("<span></span>").addClass(this.cssClass()))}},this.handlers={selectNode:function(i,n){e("select node "+i.name(),t.logTo),n()},addNode:function(i,n,s,a){e("add new node ",t.logTo),a({id:10,parent:i,name:s})},renameNode:function(i,n,s,a){e('rename node "'+n+'" to "'+s+'"',t.logTo),a()},deleteNode:function(i,n,s){e('delete node "'+i.name()+'"',t.logTo),s()},moveNode:function(i,n,s){e('move node "'+i.name()+'" to "'+n.name()+'"',t.logTo),s()},doubleClick:function(i){e("doubled clicked "+i.name(),t.logTo)},rightClick:function(i){e("right click "+i.name(),t.logTo)},startDrag:function(){e("start drag",t.logTo)},endDrag:function(){e("stop drag",t.logTo)}},$.extend(this.handlers,t.handlers||{}),t.defaults&&$.extend(!0,this.defaults,t.defaults),this.id=ko.observable(t.id),this.remember=ko.observable(t.remember||!1),this.logTo=t.logTo;var s=this;t.contextMenu&&(this.contextMenu=new ko.contextMenu.viewModel(t.contextMenu)),this.children=ko.observableArray([]);var a;for(a=0;t.children.length>a;a+=1){var o=t.children[a];this.children.push(new n(o,s,s))}this.tree=void 0,this.dragHolder=t.dragHolder||ko.observable(void 0),this.recalculateSizes=function(){var e,t=0;$(".node:visible",this.tree).each(function(i,n){var s=0,a=$(n);s+=a.children("label").outerWidth(!0),s+=a.children(".icon").outerWidth(!0),s+=a.children(".handle").outerWidth(!0),s>t&&(t=s,e=a)}),$(".node",this.tree).css("minWidth",t+5)}.bind(this),this.addNode=function(e){if(e instanceof n)e.isSelected(!1),e.setViewModel(s),e.parent(s),s.children.push(e),e.selectNode();else if(void 0!==e&&void 0===e.parent||0===this.children().length){var t=void 0!==e.type?e.type:i("childType",void 0,this),a=void 0!==e.name?e.name:i("name",t,this),o=void 0!==e.rename?e.rename:i("renameAfterAdd",t,this);this.handlers.addNode(void 0,t,a,function(e){if(void 0!==e){var t=new n(e,s,s);s.children.push(t),t.selectNode(),o&&t.isRenaming(!0),s.recalculateSizes(),t.saveState()}})}else this.selectedNode().addChild(e||{})}.bind(this),this.deleteNode=function(e){void 0!==this.selectedNode()&&this.selectedNode().deleteSelf(e)}.bind(this),this.renameNode=function(){void 0!==this.selectedNode()&&this.selectedNode().isRenaming(!0)}.bind(this)}},ko.addTemplateSafe("nodeTemplate",'					{{if hasContext() }}						<li class="${cssClass}" data-bind="contextMenu : contextMenu, css: { empty: !hasChildren(), open: isOpen, rename: isRenaming }" data-id="${ id() }">					{{else}}						<li class="${cssClass}" data-bind="css: { empty: !hasChildren(), open: isOpen, rename: isRenaming }" data-id="${ id() }">					{{/if}}						<div class="node" data-bind="nodeDrag : isDraggable(), nodeDrop: { active : isDropTarget(), onDropComplete: move }, css :{ selected: isSelected }, hover : \'hover\', event : { dblclick : doubleClick, mousedown: clicked }">							{{if hasChildren() }}								<span class="handle" data-bind="click: toggleFolder, bubble : false, style: { marginLeft: indent() }, hover : \'hover\'"></span>{{else}}<span class="handle" data-bind="style: { marginLeft: indent() }"></span>{{/if}}<span class="icon"></span><label data-bind="visible: !isRenaming()" unselectable="on">${ name }</label><input class="rename" type="text" data-bind="nodeRename: name, onRenameComplete : rename, nodeSelectVisible: isRenaming"/>						</div>						{{if hasChildren() }}							<ul data-bind=\'visible: isOpen, template: { name: "nodeTemplate", foreach: children }\'></ul>						{{/if}}					</li>',t),ko.addTemplateSafe("containerTemplate",'<ul class="tree" data-bind=\'template: { name : "nodeTemplate", foreach: children }\'></ul>',t),ko.bindingHandlers.nodeDrag={init:function(e,t,n,s){var a=$(e),o=s,d={revert:"invalid",revertDuration:250,cancel:"span.handle",cursor:i("dragCursor",o.type(),o.viewModel),cursorAt:i("dragCursorAt",o.type(),o.viewModel),appendTo:"body",connectToSortable:s.connectToSortable(),helper:function(e,t){var n=i("dragHelper",o.type(),o.viewModel);return n.call(s,e,t)},zIndex:2e5,addClasses:!1,distance:10,start:function(){s.isdragHolder(),s.viewModel.handlers.startDrag(s)},stop:function(){s.viewModel.handlers.endDrag(s)}};a.draggable(d)},update:function(e,t){var i=$(e),n=ko.utils.unwrapObservable(t());n?i.draggable("enable"):i.draggable("disable")}},ko.bindingHandlers.nodeDrop={init:function(e,t,i,n){var s=$(e),a=t()||{},o=ko.utils.unwrapObservable(a.onDropComplete),d={greedy:!0,tolerance:"pointer",addClasses:!1,drop:function(){setTimeout(function(){o(n.dropped())},0)}};s.droppable(d)},update:function(e,t){var i=$(e),n=ko.utils.unwrapObservable(t()).active;n?i.droppable("enable"):i.droppable("disable")}},ko.bindingHandlers.nodeSelectVisible={update:function(e,t){ko.bindingHandlers.visible.update(e,t);var i="none"===e.style.display;i||e.select()}},ko.bindingHandlers.nodeRename={updateValue:function(e,t,i,n){var s=i().onRenameComplete,a=ko.selectExtensions.readValue(e);s(a),n.isRenaming(!1)},init:function(e,t,i,n){var s=$(e),a=function(){ko.bindingHandlers.nodeRename.updateValue(e,t,i,n)};s.click(function(){return!1}).focus("focus",function(){}),s.bind("blur",a),s.bind("keyup",function(e){13===e.which&&a()})},update:function(e,t){ko.bindingHandlers.value.update(e,t)}},ko.bindingHandlers.tree={init:function(i,n){var s,a=n();a.tree=i,s=i.appendChild(document.createElement("DIV")),e("Initialize tree "+a.children().length+" root nodes found",a.logTo),ko.renderTemplate("containerTemplate",a,{templateEngine:t},s,"replaceNode"),a.recalculateSizes()}}})();