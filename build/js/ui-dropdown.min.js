/*!
 * Knockout-UI v0.5.0
 * A home for rich UI components based on KnockoutJS
 * Copyright (c) 2013 Ian Mckay
 * https://github.com/madcapnmckay/Knockout-UI.git
 * License: MIT (http://opensource.org/licenses/mit-license.php)
**/
(function(t){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?t(require("knockout"),require("jquery"),require("ui-core"),exports):"function"==typeof define&&define.amd?define(["knockout","jquery","ui-core","exports"],t):t(ko,$,ko.ui.core,ko.ui)})(function(t,e,n,i){"use strict";var o,a="ko_dropdown_model";t.addTemplate("tmpl_ui_dropdown",["<div class='ui-dropdown'>","<input type='text' data-bind='UIDropdownInput: {}' />","<a tabindex='-1' data-bind='UIDropdownButton : {}'>+</a>","</div>"].join("")),i.defaults=i.defaults||{},o=i.defaults.dropdown={template:"tmpl_ui_dropdown",css:{container:"ui-dropdown",button:"ui-button",searching:"ui-searching"},autocomplete:{minLength:2}},i.Dropdown=n.Component.extend({init:function(e){var i=this;this.options=n.extend({},o,e.options),this.data=t.isObservable(e.data)?e.data:t.observableArray(e.data||[]),this.value=t.observable(),this.label=t.observable(),this.optionsText=e.optionsText,this.optionsValue=e.optionsValue,this.optionsCaption=e.optionsCaption,this.mapped=t.computed(function(){return t.utils.arrayMap(n.unwrap(i.data),i.mapDataItem.bind(i))}),this.autocompleteOptions=this._getAutocompleteOptions()},mapDataItem:function(t){var e=this.optionsText,n=this.optionsValue;if("string"==typeof t||"number"==typeof t)return t;var i={};return e&&(i.label=t[e]),n&&(i.value=t[n]),i},_getAutocompleteOptions:function(){var i,a=this;return i=this.options.autocomplete.source||function(i,o){var r=RegExp(e.ui.autocomplete.escapeRegex(i.term),"i");o(t.utils.arrayMap(t.utils.arrayFilter(n.unwrap(a.mapped),function(t){return t.label&&(!i.term||r.test(t.label))}),function(t){return{label:i.term?t.label.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+e.ui.autocomplete.escapeRegex(i.term)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>"):t.label,rawLabel:t.label,value:t.value}}))},n.extend({source:i,select:function(t,e){a.value(e.item.value),t.preventDefault()},focus:function(t,e){a.label(e.item.rawLabel),t.preventDefault()}},o.autocomplete)},isAjax:function(){var t=this.options.autocomplete.source;return t&&"string"==typeof t},push:function(t){this.data.push(t)}}),t.bindingHandlers.dropdown={init:function(o,r,s){var u=r(),l=e(o),p=s(),d=p.value;return u instanceof i.Dropdown||(u=n.isArray(n.unwrap(u))?new i.Dropdown({data:u,optionsText:p.optionsText,optionsValue:p.optionsValue,optionsCaptions:p.optionsCaption}):new i.Dropdown({data:l.children("option").map(function(){return{label:this.text,value:this.value}}),optionsText:"label",optionsValue:"value"})),u.value=d||u.value,t.utils.domData.set(o,a,u),t.renderTemplate(u.options.template,u,{},o.parentNode.insertBefore(document.createElement("div"),o.nextSibling),"replaceNode"),{controlsDescendantBindings:!0}},update:function(e,n,i,o){var r,s,u=t.utils.domData.get(e,a);u.isAjax()||(r=function(){return u.data},s=function(){return{optionsText:u.optionsText,optionsValue:u.optionsValue,optionsCaption:u.optionsCaption}},u.value&&(s.value=u.value),t.bindingHandlers.options.update(e,r,s,o))}},t.bindingHandlers.UIDropdownInput={init:function(i,o,a,r){var s,u=r,l=u.value,p=e(i);s=p.autocomplete(u.autocompleteOptions).data("autocomplete"),s._renderItem=function(t,n){return e("<li></li>").data("item.autocomplete",n).append("<a>"+n.label+"</a>").appendTo(t)},u.label.subscribe(function(t){p.val(t)}),l&&l.subscribe&&!u.isAjax()&&l.subscribe(function(e){var i=e;if(u.optionsText){var o=t.utils.arrayFilter(n.unwrap(u.data),function(t){var n=u.optionsValue?t[u.optionsValue]:t;return n==e});o.length&&(i=o[0][u.optionsText])}u.label(i)}),t.utils.domNodeDisposal.addDisposeCallback(i,function(){e(i).autocomplete("destroy")})}},t.bindingHandlers.UIDropdownButton={init:function(n,i,o,a){var r=a,s=e(n),u=s.parents("."+r.options.css.container),l=u.find("input");t.bindingHandlers.click.init.call(this,n,function(){return function(){l.each(function(t,n){var i=e(n),o=i.data("autocomplete");if(o){if(i.autocomplete("widget").is(":visible"))return i.blur(),!1;s.blur(),i.addClass(r.options.css.searching).autocomplete("option","minLength",0).autocomplete("search","").autocomplete("option",r.autocompleteOptions.minLength||0),i.focus()}})}},o,a)}}});